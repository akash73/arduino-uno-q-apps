name: Build zips and attach to Release

on:
  release:
    types: [published, prereleased, created]
  workflow_dispatch:

permissions:
  contents: write

run:
    echo "event=${{ github.event_name }}"
    echo "action=${{ github.event.action }}"
    echo "tag=${{ github.event.release.tag_name }}"

jobs:
  zip-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create a zip inside each top-level folder + zips.yml
        shell: bash
        run: |
          set -euo pipefail

          OUT_FILE="zips.yml"
          echo "# List of zip assets generated by the workflow" > "$OUT_FILE"

          for dir in */ ; do
            folder="${dir%/}"

            # Escludi cartelle che non vuoi zippare
            case "$folder" in
              .github) continue ;;
            esac

            zip_path="${folder}/${folder}.zip"

            # Crea lo zip dentro la cartella (escludendo altri zip)
            (
              cd "$folder"
              zip -r -q "${folder}.zip" . -x "*.zip"
            )

            # Aggiungi al file YAML (una riga per zip, formato lista)
            echo "- ${zip_path}" >> "$OUT_FILE"

            echo "Created: ${zip_path}"
          done

      - name: Upload assets to the Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            */*.zip
            zips.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
